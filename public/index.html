<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/default.css">
</head>
<body>
  <h1 class="main-header">the gnarly tyke</h1>
  <div>
    <h2 class="area-name">Baildon Bank</h2>
  </div>
  <div style="margin-top: 2%;">
    <canvas style="margin: auto; display: block" id="topo-canvas"></canvas>
  </div>
  <div style="margin-top: 2%;">
    <table class="route-table" id="route-table" style="width: 80%; margin: auto">
      <thead>
          <tr>
            <th></th>
            <th>Name</th>
            <th>Type</th>
            <th>Grade</th>
          </tr>
      </thead>
      <tbody id="route-table-body">
        <script>
          let routes = 
          [
            { "name": "Conch", "type": "Trad", "grade": "HS 4b" },
            { "name": "Scar Wall", "type": "Trad", "grade": "E5 6b" },
            { "name": "Scar", "type": "Trad", "grade": "E2 5b" },
            { "name": "The Flakes", "type": "Trad", "grade": "E3 5c" },
            { "name": "Intrepid", "type": "Trad", "grade": "E6 6a" }
          ];
          routes.forEach((route, index) => {
            let rowHTML = 
            `<tr>
              <td>${index+1}</td>
              <td>${route.name}</td>
              <td>${route.type}</td>
              <td>${route.grade}</td>
            </tr>
            `;
            document.write(rowHTML);
          });
        </script>
      </tbody>
    </table>
  </div>
  <script>
    let workingTopoData = null;
    const topoData = [
      {
        "imageFile": "./images/conch-area-resize.jpg",
        "routes": [ 
          { "label": 1, "points": { "start": { "x": 0.42, "y": 0.85 }, "end": { "x": 0.6, "y": 0.15 } } }
        ]
      },
      {
        "imageFile": "./images/scar-wall-resize.jpg",
        "routes": [
          { "label": 2, "points": { "start": { "x": 0.30, "y": 0.80 }, "end": { "x": 0.34, "y": 0.15 } } },
          { "label": 3, "points": { "start": { "x": 0.44, "y": 0.80 }, "end": { "x": 0.48, "y": 0.12 } } },
          { "label": 4, "points": { "start": { "x": 0.56, "y": 0.80 }, "end": { "x": 0.55, "y": 0.12 } } },
          { "label": 5, "points": { "start": { "x": 0.62, "y": 0.82 }, "end": { "x": 0.62, "y": 0.15 } } }
        ]
      }
    ];
    window.onload = function() {
      let loaders = topoData.map(topo => LoadImage(topo.imageFile));
      Promise.all(loaders).then(images => {
        workingTopoData = topoData.map( (topo, index) => {
          return { image: images[index], routes: topo.routes };
        });
        DrawCanvas(workingTopoData);
      });
    }
    window.onresize = () => {
      DrawCanvas(workingTopoData);
    }
    let DrawCanvas = (topoData) => {
      let canvas = document.getElementById("topo-canvas");
      canvas.width = document.documentElement.clientWidth;
      canvas.height = document.documentElement.clientHeight * 0.5;
      const imageScales = GetImageScales(canvas, topoData.map(topo => topo.image), 1);
      const imageRenders = GetRenderData(canvas, topoData, imageScales);
      imageRenders.forEach( (imageRender) => {
        DrawTopoImage(canvas, imageRender.image, imageRender.width, imageRender.height, imageRender.position, imageRender.routes);
      });
    }
    let DrawTopoImage = (canvas, img, imageWidth, imageHeight, imageShiftRight, routes) => {
      let ctx = canvas.getContext("2d");
      ctx.drawImage(img, imageShiftRight, 0, imageWidth, imageHeight);
      const transformedRoutes = TransformRoutes(routes, imageWidth, imageHeight, imageShiftRight);
      transformedRoutes.forEach( route => {
        DrawLine(ctx, route.points);
      });
      const labels = transformedRoutes.map( route => { 
        return { value: route.label, pos: route.points.start };
      });
      labels.forEach( label => {
        DrawLabel(ctx, label);
      });
    }
    let LoadImage = (url) => new Promise( (resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = (err) => reject(err);
      img.src = url;
    });
    let GetImageScales = (canvas, images, imageHeightScale) => {
      return images.map(image => canvas.height / image.height * imageHeightScale);
    }
    let TransformRoutes = (routes, imageWidth, imageHeight, imageShiftX) => {
      return routes.map(route => {
        return {
          label: route.label, points: { 
            start: { x: route.points.start.x * imageWidth + imageShiftX, y: route.points.start.y * imageHeight}, 
            end: { x: route.points.end.x * imageWidth + imageShiftX, y: route.points.end.y * imageHeight}
          }
        };
      });
    }
    let GetRenderData = (canvas, topos, imageScales) => {
      // let imageWidths = topos.map( (topo, index) => topo.image.width * imageScales[index]);
      let imageSizes = topos.map( (topo, index) => {
        return { width: topo.image.width * imageScales[index], height: topo.image.height * imageScales[index] };
      });
      return [
        { image: topos[0].image, width: imageSizes[0].width, height: imageSizes[0].height, position: canvas.width / 2 - imageSizes[0].width - 10, routes: topos[0].routes },
        { image: topos[1].image, width: imageSizes[1].width, height: imageSizes[1].height, position: canvas.width / 2 + 10, routes: topos[1].routes }
      ];
    }
    let DrawLine = (ctx, line) => {
      const lineWidth = ctx.canvas.height * 0.01;
      const lineDash = ctx.canvas.height * 0.01;
      ctx.strokeStyle = 'white';
      ctx.beginPath();
      ctx.lineWidth = lineWidth;
      ctx.strokeStyle = '#FFFFFF';
      ctx.setLineDash([]);
      ctx.moveTo(line.start.x, line.start.y);
      ctx.lineTo(line.end.x, line.end.y);
      ctx.stroke();
      ctx.beginPath();
      ctx.lineWidth = lineWidth;
      ctx.strokeStyle = '#0a5f16';
      ctx.setLineDash([lineDash * 2, lineDash]);
      ctx.moveTo(line.start.x, line.start.y);
      ctx.lineTo(line.end.x, line.end.y);
      ctx.stroke();
    }
    let DrawLabel = (ctx, label) => {
      const size = ctx.canvas.height * 0.02;
      const fontSize = size * 2;
      ctx.beginPath();
      ctx.setLineDash([]);
      ctx.arc(label.pos.x, label.pos.y, size, 0, 2 * Math.PI, false);
      ctx.fillStyle = "#FFFFFF";
      ctx.fill();
      ctx.beginPath();
      ctx.arc(label.pos.x, label.pos.y, size, 0, 2 * Math.PI, false);
      ctx.lineWidth = size * 0.1;
      ctx.strokeStyle = "#000000";
      ctx.stroke();
      ctx.font = `bold ${fontSize}px serif`;
      ctx.fillStyle = "#000000";
      ctx.fillText(label.value, label.pos.x - (size * 0.5), label.pos.y + (size * 0.75));
    }
    </script>
</body>
</html>
