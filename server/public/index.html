<!DOCTYPE html>
<meta charset="UTF-8">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/default.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <div><h1>the gnarly tyke</h1></div>
  <div><h2>Baildon Bank</h2><div>
  <div id="topo-images-container" class="topo-images-container"></div>
  <div class="do-not-display"><p id="current-topo-id"></p></div>
  <div id="main-topo-container" class="main-topo-container do-not-display">
    <canvas id="main-topo-image" class="main-topo-image"></canvas>
    <table id="topo-route-table" class="new-topo-route-table">
      <thead class="topo-route-table-header">
          <tr>
            <th></th>
            <th>Name</th>
            <th>Grade</th>
          </tr>
      </thead>
    </table>
  </div>
  <script src="./bundle.js"></script>
  <script>
    let _cragObject = null;
    let _selectedTopoImageContainer = null;
    window.onload = () => {
      fetch('./data/crag.json')
      .then(response => response.json())
      .then(crag => {
        _cragObject = CreateCragObject(crag);
        let cragTopoIDs = GetCragTopoIDs(_cragObject);
        let topoImageContainers = cragTopoIDs.map( topoID => {
          return document.getElementById('topo-images-container').appendChild(CreateTopoImageContainer(topoID));
        });
        let topoImageFilenames = cragTopoIDs.map( id => GetTopoImageFile(_cragObject, id) );
        cragTopoIDs.forEach( (topoID, index) => {
          let imageFilename = GetTopoImageFile(_cragObject, topoID);
          if( imageFilename ) {
            LoadImage(`./images/${imageFilename}`)
            .then( topoImage => DisplayTopoImage(topoImage, topoImageContainers[index], topoID) );
          }
        });
      });
    }
    window.onresize = () => {
    }
    let CreateTopoImageContainer = (topoID) => {
      let container = document.createElement('div');
      container.classList.add('topo-container');
      container.setAttribute('data-id', topoID);
      return container;
    }
    let DisplayTopoImage = (topoImage, topoImageContainer, topoID) => {
      let topoCanvas = CreateTopoCanvas(topoImage, 10);
      topoImageContainer.appendChild(topoCanvas);
      let ctx = topoCanvas.getContext('2d');
      ctx.drawImage(topoImage, 0, 0, topoCanvas.width, topoCanvas.height);
      topoCanvas.onclick = event => {
        if( _selectedTopoImageContainer ) _selectedTopoImageContainer.classList.remove('topo-container-selected');
        _selectedTopoImageContainer = topoImageContainer;
        topoImageContainer.classList.add('topo-container-selected');
        DrawMainTopoImage(topoImage);
        DrawMainTopoOverlay(topoID);
        RefreshTopoRouteTable(topoID);
        document.getElementById('main-topo-container').classList.remove('do-not-display');
      }
    }
    let CreateTopoCanvas = (topoImage, heightInRem) => {
      let canvas = document.createElement('CANVAS');
      canvas.classList.add('topo-image');
      let height = heightInRem;
      let width = topoImage.width * height / topoImage.height;
      canvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      canvas.setAttribute('width', topoImage.width);
      canvas.setAttribute('height', topoImage.height);
      return canvas;
    }
    let DrawMainTopoImage = topoImage => {
      let destCanvas = document.getElementById('main-topo-image');
      let width = 60;
      let height = topoImage.height * width / topoImage.width;
      destCanvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      destCanvas.setAttribute('width', topoImage.width);
      destCanvas.setAttribute('height', topoImage.height);
      destCanvas.height = topoImage.height;
      destCanvas.width = topoImage.width * destCanvas.height / topoImage.height;
      let destCanvasCtx = destCanvas.getContext('2d');
      destCanvasCtx.drawImage(topoImage, 0, 0, destCanvas.width, destCanvas.height);
      return destCanvas;
    }
    let RefreshTopoRouteTable = topoID => {
      let topoRouteTable = document.getElementById("topo-route-table");
      while( topoRouteTable.rows.length > 1 ) topoRouteTable.deleteRow(1);
      GetTopoRouteIDs(_cragObject, topoID).forEach( routeID => {
        let topoRouteInfo = GetCragRouteInfo(_cragObject, routeID);
        let newRow = topoRouteTable.insertRow(topoRouteTable.rows.length);
        newRow.insertCell(0).innerText = topoRouteTable.rows.length - 1;
        newRow.insertCell(1).innerText = topoRouteInfo.name;
        newRow.insertCell(2).innerText = topoRouteInfo.grade;
      });
    }
    let DrawMainTopoOverlay = topoID => {
      let topoIDs = GetCragTopoIDs(_cragObject);
      let topoRouteRenderSteps = GetTopoOverlayRenderSteps(_cragObject, topoID);
      let topoCanvas = document.getElementById('main-topo-image');
      let ctx = topoCanvas.getContext('2d');
      topoRouteRenderSteps.forEach( renderStep => {
        switch( renderStep.type ) {
          case rsRouteStart:
            DrawRoutePoint(ctx, topoCanvas.width * renderStep.x, topoCanvas.height * renderStep.y, renderStep.index, 1, "rgb(40, 150, 40)");
            break;
          case rsRouteEnd:
            DrawRoutePoint(ctx, topoCanvas.width * renderStep.x, topoCanvas.height * renderStep.y, renderStep.index, 1, "rgb(150, 20, 20)");
            break;
          case rsRouteLine:
            DrawRouteLine(ctx,
              topoCanvas.width * renderStep.start.x, topoCanvas.height * renderStep.start.y, 
              topoCanvas.width * renderStep.end.x, topoCanvas.height * renderStep.end.y, 1);
            break;
        }
      });
    }
    let DrawRoutePoint = (ctx, canvasX, canvasY, routeIndex, fontSize, colour) => {
      ctx.font = `bold ${fontSize}rem serif`;
      const metrics = ctx.measureText(routeIndex);
      let widthOfRouteIndex = metrics.width;
      ctx.beginPath();
      ctx.setLineDash([]);
      ctx.arc(canvasX, canvasY, widthOfRouteIndex * 1.2, 0, 2 * Math.PI, false);
      ctx.fillStyle = colour;
      ctx.fill();
      ctx.beginPath();
      ctx.arc(canvasX, canvasY, widthOfRouteIndex * 1.2, 0, 2 * Math.PI, false);
      ctx.lineWidth = fontSize;
      ctx.strokeStyle = "#000000";
      ctx.stroke();
      ctx.fillStyle = "rgb(230,230,230)";
      ctx.fillText(routeIndex, canvasX - (widthOfRouteIndex * 0.5), canvasY + (widthOfRouteIndex * 0.6));
    }
    let DrawRouteLine = (ctx, canvasStartX, canvasStartY, canvasEndX, canvasEndY, width) => {
      ctx.beginPath();
      ctx.setLineDash([10, 10]);
      ctx.moveTo(canvasStartX, canvasStartY);
      ctx.lineTo(canvasEndX, canvasEndY);
      ctx.lineWidth = "4";
      ctx.strokeStyle = '#FFFFFF';
      ctx.stroke();
    }
    </script>
</body>
</html>
