<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/default.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <script src="./common.js"></script>
  <div><h1>the gnarly tyke</h1></div>
  <div><h2>Baildon Bank</h2><div>
  <div id="topo-images-container" class="topo-images-container"></div>
  <div class="do-not-display"><p id="current-topo-id"></p></div>
  <div id="main-topo-container" class="main-topo-container do-not-display">
    <canvas id="main-topo-image" class="main-topo-image"></canvas>
    <table id="topo-route-table" class="topo-route-table">
      <thead class="topo-route-table-header">
          <tr>
            <th></th>
            <th>Name</th>
            <th></th>
            <th>Grade</th>
          </tr>
      </thead>
    </table>
  </div>
  <div id="edit-topo-container" class="do-not-display">
    <div id="icon-bar" class="icon-bar">
      <label for="new-route-name">Name:</label>
      <input id="new-route-name">
      <label for="new-route-grade">Grade:</label>
      <input id="new-route-grade">
      <a href="#"><i class="fa fa-plus" id="ib-add-route"></i></a>
      <a href="#"><i class="fa fa-save" id="ib-save"></i></a>
    </div>
    <div>
      <table id="crag-route-table" class="crag-route-table">
        <thead class="crag-route-table-header">
            <tr>
              <th>Index</th>
              <th data-property-name="name">Name</th>
              <th data-property-name="grade">Grade</th>
              <th data-property-name="onTopo">On topo</th>
              <th data-property-name="id">ID</th>
              <th data-property-name="points">Points</th>
            </tr>
        </thead>
      </table>
      </div>
  </div>
  <script type="module">
    let _crag = null;
    let _currentTopoID = null;
    let _currentTopoImage = null;
    let _selectedTopoContainerElement = null;
    window.onload = () => {
      LoadCrag();
    }
    window.onresize = () => {
    }
    let LoadCrag = () => {
      fetch('./data/crag.json')
      .then(response => response.json())
      .then(crag => {
        _crag = crag;
        UpdateCragRouteTable(_crag.routes);
        let topoContainers = CreateTopoContainers(document.getElementById('topo-images-container'), _crag.topos);
        LoadTopoImagesFromCrag(_crag, DisplayTopoImageInCragView, './images/');
      });
    }
    let CreateTopoContainers = (parentContainer, topos) => {
      let topoContainers = [];
      topos.forEach(topo => {
        let topoContainer = parentContainer.appendChild(document.createElement('div'));
        topoContainer.classList.add('topo-container');
        topoContainer.setAttribute('data-id', topo.id);
        topoContainer.setAttribute('data-filename', topo.imageFile);
        topoContainers.push(topoContainer);
      });
      return topoContainers;
    }
    let DisplayTopoImageInCragView = (cragObject, topo, topoImage) => {
      let topoImagesContainer = document.getElementById('topo-images-container');
      let matchingTopoContainers = Array.from(topoImagesContainer.children).filter( topoContainer => {
        return topoContainer.getAttribute('data-id') == topo.id;
      });
      let topoContainer = matchingTopoContainers[0];
      let topoCanvas = CreateTopoCanvas(topoImage, 10);
      topoContainer.appendChild(topoCanvas);
      let ctx = topoCanvas.getContext('2d');
      ctx.drawImage(topoImage, 0, 0, topoCanvas.width, topoCanvas.height);
      topoCanvas.onclick = event => {
        document.getElementById('main-topo-container').classList.remove('do-not-display');
        SwitchMainTopoView(topo, topoImage);
      }
    }
    let SwitchMainTopoView = (topoObject, topoImage) => {
      _currentTopoID = topoObject.id;
      if( _selectedTopoContainerElement ) _selectedTopoContainerElement.classList.remove('topo-container-selected');
      _selectedTopoContainerElement = GetTopoContainerElement(topoObject.id);
      _selectedTopoContainerElement.classList.add('topo-container-selected');
      document.getElementById('current-topo-id').textContent = _currentTopoID;
      _currentTopoImage = topoImage;
      let mainTopoCanvas = DrawMainTopoImage(topoImage);
      RefreshMainTopoView(topoObject, topoImage);
    }
    let GetTopoContainerElement = id => {
      let parentContainerElement = document.getElementById('topo-images-container');
      let matchingTopoContainers = Array.from(parentContainerElement.children).filter( topoContainerElement => topoContainerElement.dataset.id == id );
      return matchingTopoContainers[0];
    }
    let DrawTopoRoutes = (ctx) => {
      GetCheckedCragTableRows().forEach( (row, rowIndex) => {
        let routeDataText = row.cells[5].innerText;
        if( routeDataText.length > 0 ) {
          let routeDataObject = JSON.parse(routeDataText);
          let pointsOnCanvas = routeDataObject.map( point => {
            return { x: ctx.canvas.width * point.x, y: ctx.canvas.height * point.y };
          });
          pointsOnCanvas.forEach( (point, pointIndex, points) => {
            let nextPoint = points[pointIndex+1];
            if( nextPoint ) DrawRouteLine(ctx, point.x, point.y, nextPoint.x, nextPoint.y, 1);
            // DrawRouteStart(ctx, point.x, point.y, rowIndex + 1, 1);
          });
          let startPoint = pointsOnCanvas[0];
          if( startPoint ) DrawRouteStart(ctx, startPoint.x, startPoint.y, rowIndex + 1, 1.2, "rgb(40, 150, 40)");
          let endPoint = pointsOnCanvas[pointsOnCanvas.length-1];
          if( endPoint ) DrawRouteStart(ctx, endPoint.x, endPoint.y, rowIndex + 1, "1.2", "rgb(150, 20, 20)");
        }
      });
    }
    let DrawRouteStart = (ctx, canvasX, canvasY, routeIndex, fontSize, colour) => {
      ctx.font = `bold ${fontSize}rem serif`;
      const metrics = ctx.measureText(routeIndex);
      let widthOfRouteIndex = metrics.width;
      ctx.beginPath();
      ctx.setLineDash([]);
      ctx.arc(canvasX, canvasY, widthOfRouteIndex, 0, 2 * Math.PI, false);
      ctx.fillStyle = colour;
      ctx.fill();
      ctx.beginPath();
      ctx.arc(canvasX, canvasY, widthOfRouteIndex, 0, 2 * Math.PI, false);
      ctx.lineWidth = fontSize;
      ctx.strokeStyle = "#000000";
      ctx.stroke();
      ctx.fillStyle = "#000000";
      ctx.fillText(routeIndex, canvasX - (widthOfRouteIndex * 0.5), canvasY + (widthOfRouteIndex * 0.75));
    }
    let DrawRouteLine = (ctx, canvasStartX, canvasStartY, canvasEndX, canvasEndY, width) => {
      ctx.beginPath();
      ctx.setLineDash([10, 10]);
      ctx.moveTo(canvasStartX, canvasStartY);
      ctx.lineTo(canvasEndX, canvasEndY);
      ctx.lineWidth = "4";
      ctx.strokeStyle = '#FFFFFF';
      ctx.stroke();
    }
    let CreateTopoCanvas = (topoImage, heightInRem) => {
      let canvas = document.createElement('CANVAS');
      canvas.classList.add('topo-image');
      let height = heightInRem;
      let width = topoImage.width * height / topoImage.height;
      canvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      canvas.setAttribute('width', topoImage.width);
      canvas.setAttribute('height', topoImage.height);
      return canvas;
    }
    let UpdateCragRouteTable = (routes) => {
      let routeTable = document.getElementById("crag-route-table");
      DeleteAllTableRowsExceptHeader(routeTable);
      routes.forEach( route => {
        AddRouteToCragRouteTable(route.name, route.grade, route.id);
      });
    }
    let UpdateTopoRouteTableFromCragRouteTable = () => {
      let cragRouteTable = document.getElementById("crag-route-table");
      let topoRouteTable = document.getElementById("topo-route-table");
      DeleteAllTableRowsExceptHeader(topoRouteTable);
      GetCheckedCragTableRows().forEach( row => {
        let routeName = row.cells[1].innerText;
        let routeGrade = row.cells[2].innerText;
        let routeID = row.cells[4].innerText;
        let newRouteIndex = topoRouteTable.rows.length;
        let newRouteRow = topoRouteTable.insertRow(newRouteIndex);
        newRouteRow.insertCell(0).innerText = newRouteIndex;
        newRouteRow.insertCell(1).innerText = routeName;
        newRouteRow.insertCell(2).innerText = routeID;
        newRouteRow.insertCell(3).innerText = routeGrade;
      });
      let topoCanvas = document.getElementById('main-topo-image');
      let ctx = topoCanvas.getContext('2d');
      DrawMainTopoImage(_currentTopoImage);
      DrawTopoRoutes(ctx);
    }
    let GetCheckedCragTableRows = () => {
      let cragRouteTable = document.getElementById("crag-route-table");
      return GetTableRowsWithoutHeader(cragRouteTable).filter( row => IsTableCellChecked(row, 3) );
    }
    let CreateCheckboxInputElement = () => {
      let inputElement = document.createElement('input');
      inputElement.setAttribute('type','checkbox');
      return inputElement;
    }
    let DrawMainTopoImage = topoImage => {
      let destCanvas = document.getElementById('main-topo-image');
      let width = 60;
      let height = topoImage.height * width / topoImage.width;
      destCanvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      destCanvas.setAttribute('width', topoImage.width);
      destCanvas.setAttribute('height', topoImage.height);
      destCanvas.height = topoImage.height;
      destCanvas.width = topoImage.width * destCanvas.height / topoImage.height;
      let destCanvasCtx = destCanvas.getContext('2d');
      destCanvasCtx.drawImage(topoImage, 0, 0, destCanvas.width, destCanvas.height);
      return destCanvas;
    }
    let RefreshMainTopoView = (topoObject, topoImage) => {
      if( topoObject?.routes ) SetCragTableRoutesAsTopoRoutes(topoObject.routes);
      UpdateTopoRouteTableFromCragRouteTable();
    }
    let AddRouteToCragRouteTable = (routeName, routeGrade, routeID) => {
      let routeTable = document.getElementById("crag-route-table");
      let newRouteIndex = routeTable.rows.length;
      let newRouteRow = routeTable.insertRow(newRouteIndex);
      newRouteRow.insertCell(0).innerText = newRouteIndex;
      newRouteRow.insertCell(1).innerText = routeName;
      newRouteRow.insertCell(2).innerText = routeGrade;
      let checkbox = CreateCheckboxInputElement();
      checkbox.onchange = event => {
        UpdateTopoRouteTableFromCragRouteTable();
      };
      newRouteRow.insertCell(3).appendChild(checkbox);
      newRouteRow.insertCell(4).innerText = routeID ? routeID : GetNextID();
      newRouteRow.insertCell(5).innerText = '';
    }
    let SetCragTableRoutesAsTopoRoutes = (routes) => {
      let setOfRouteIDs = new Map(routes.map(route => [route.id, route]));
      let cragRouteTableElement = document.getElementById('crag-route-table');
      let cragRouteTableRows = GetTableRowsWithoutHeader(cragRouteTableElement);
      cragRouteTableRows.forEach( row => {
        let rowID = row.cells[4].innerText;
        let route = setOfRouteIDs.get(rowID);
        if( route ) {
          row.cells[3].firstChild.checked = true;
          row.cells[5].innerText = route.points ? JSON.stringify(route.points) : '';
        }
        else {
          row.cells[3].firstChild.checked = false;
          row.cells[5].innerText = '';
        }
      });
    }
    </script>
</body>
</html>
