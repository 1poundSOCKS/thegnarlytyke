<!DOCTYPE html>
<meta charset="UTF-8">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/default.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <div><h1>the gnarly tyke</h1></div>
  <div><h2>Baildon Bank</h2><div>
  <div id="topo-images-container" class="topo-images-container"></div>
  <div class="do-not-display"><p id="current-topo-id"></p></div>
  <div id="main-topo-container" class="main-topo-container do-not-display">
    <canvas id="main-topo-image" class="main-topo-image"></canvas>
    <table id="topo-route-table" class="new-topo-route-table"></table>
  </div>
  <script src="./bundle.js"></script>
  <script>
    let _cragObject = null;
    let _topoImages = new Map();
    let _selectedTopoImageContainer = null;
    window.onload = () => {
      fetch('./data/crag.json')
      .then(response => response.json())
      .then(crag => {
        _cragObject = CreateCragObject(crag);
        let cragTopoIDs = GetCragTopoIDs(_cragObject);
        let topoImageContainers = cragTopoIDs.map( topoID => {
          return document.getElementById('topo-images-container').appendChild(CreateTopoImageContainer(topoID));
        });
        let topoImageCanvases = topoImageContainers.map( container => {
          let topoCanvas = container.appendChild(document.createElement('CANVAS'));
          topoCanvas.classList.add('topo-image');
          topoCanvas.onclick = event => {
            if( _selectedTopoImageContainer ) _selectedTopoImageContainer.classList.remove('topo-container-selected');
            _selectedTopoImageContainer = topoCanvas.parentElement;
            _selectedTopoImageContainer.classList.add('topo-container-selected');
            let selectedTopoID = _selectedTopoImageContainer.dataset.id;
            let selectedTopoImage = _topoImages.get(selectedTopoID);
            let mainTopoCanvas = document.getElementById('main-topo-image');
            DrawMainTopoImage(mainTopoCanvas, selectedTopoImage, 60);
            DrawMainTopoOverlay(mainTopoCanvas, _cragObject, selectedTopoID);
            let topoRouteTable = document.getElementById("topo-route-table");
            RefreshTopoRouteTable(topoRouteTable, _cragObject, selectedTopoID);
            document.getElementById('main-topo-container').classList.remove('do-not-display');
          }
          return topoCanvas;
        });
        topoImageCanvases.forEach( canvas => {
          let topoID = canvas.parentElement.dataset.id;
          let imageFilename = GetTopoImageFile(_cragObject, topoID);
          if( imageFilename ) {
            LoadImage(`./images/${imageFilename}`)
            .then( topoImage => {
              _topoImages.set(topoID, topoImage);
              DisplayTopoImage(canvas, topoImage, 10);
            });
          }
        });
      });
    }
    window.onresize = () => {
    }
    </script>
</body>
</html>
