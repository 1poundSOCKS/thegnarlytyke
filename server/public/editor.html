<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/default.css">
</head>
<body>
  <script src="./common.js"></script>
  <h1>the gnarly tyke</h1>
  <div>
    <h2>Add topo</h2>
  </div>
  <div style="margin-top: 2%;">
    <input type="file" id="myFile" name="filename" onchange="example()">
  </div>
  <div style="margin-top: 2%;">
    <canvas id="topo-canvas"></canvas>
  </div>
  <div style="margin-top: 2%;">
    <button type="button" onclick="Upload()">Upload</button>
  </div>
  <div style="margin-top: 2%;">
    <label>Topo ID:
      <input id="topoID" size="50">
    </label>
  </div>
  <div style="margin-top: 2%;">
    <label>Topo filename:
      <input id="topoFilename" size="50">
    </label>
  </div>
  <div style="margin-top: 2%;">
    <button type="button" onclick="Download()">Download</button>
  </div>
  <div style="margin-top: 2%;">
    <canvas id="download-topo-canvas"></canvas>
  </div>
  <script>
    let _crag = null;
    window.onload = function() {
      LoadCrag("./data/baildon_bank.json", "./images/")
      .then( crag => {
        _crag = crag;
        _selectedTopoId = _crag.topos[0].id;
        DrawPage(_crag);
      });
    }
    window.onresize = () => {
      if( _crag ) DrawPage(_crag);
    }
    let DrawPage = (crag) => {
    }
    let example = () => {
      let element = document.getElementById('myFile');
      var reader = new FileReader();
      reader.onload = e => {
        LoadImage(e.target.result)
        .then( img => {
          const canvas = document.getElementById("topo-canvas");
          canvas.height = 500;
          canvas.width = img.width * canvas.height / img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        });
      }
      reader.readAsDataURL(element.files[0]);
    }
    let Upload = async () => {
      const canvas = document.getElementById("topo-canvas");
      const topoImageURL = canvas.toDataURL('image/jpeg', 0.5);
      const req = { imageData: topoImageURL };
      const response = await fetch('/add_topo', {
        method: 'POST',
        mode: 'same-origin',
        cache: 'no-cache',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json'
        },
        redirect: 'follow',
        referrerPolicy: 'same-origin',
        body: JSON.stringify(req)
      });
      const resData = await response.json();
      console.log(resData);
      console.log(resData.topo.imageFile);
      document.getElementById('topoID').value = resData.topo.id;
      document.getElementById('topoFilename').value = resData.topo.imageFile;
      return resData;
    }
    let Download = async () => {
      const imageFilename = document.getElementById('topoFilename').value;
      const image = await LoadImage(`/get_image?filename=${imageFilename}`);
      const canvas = document.getElementById("download-topo-canvas");
      canvas.width = image.width;
      canvas.height = image.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(image, 0, 0);
    }
    </script>
</body>
</html>
