<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/default.css">
</head>
<body>
  <script src="./common.js"></script>
  <h1>the gnarly tyke</h1>
  <div>
    <h2>Add topos</h2>
  </div>
  <div style=" margin: auto; margin-top: 2%;">
    <input type="file" multiple id="topo-image-files" name="filename" onchange="OnSelectImageFiles()">
  </div>
  <!-- <div style="margin-top: 2%;">
    <table id="topo-image-table" style="margin: auto">
      <thead>
          <tr>
            <th>File</th>
            <th>Image</th>
            <th>Topo ID</th>
          </tr>
      </thead>
      <tbody id="topo-image-table-body">
      </tbody>
    </table>
  </div> -->
  <div style="margin: auto; margin-top: 2%;">
    <canvas id="topo-canvas" style="border: 1px solid black;"></canvas>
  </div>
  <div style="margin-top: 2%;">
    <button type="button" id="previous" onclick="Previous()">Previous</button>
    <button type="button" id="next" onclick="Next()">Next</button>
    <button type="button" id="upload" onclick="Upload()">Upload</button>
    <button type="button" id="download" onclick="Download()">Download</button>
  </div>
  <div style="margin-top: 2%;">
    <label>Topo ID:
      <input id="topoID" size="50">
    </label>
  </div>
  <div style="margin-top: 2%;">
    <label>Topo filename:
      <input id="topoFilename" size="50">
    </label>
  </div>
  <div style="margin-top: 2%;">
  </div>
  <div style="margin-top: 2%;">
    <canvas id="download-topo-canvas" style="border: 1px solid black;"></canvas>
  </div>
  <script>
    let _topoImageFiles = [];
    let _currentTopoImageFileIndex = null;
    window.onload = function() {
      let topoCanvas = document.getElementById('topo-canvas');
      topoCanvas.width = 500;
      topoCanvas.height = 500;
      let downloadTopoCanvas = document.getElementById('download-topo-canvas');
      downloadTopoCanvas.width = 500;
      downloadTopoCanvas.height = 500;
      document.getElementById("previous").disabled = true;
      document.getElementById("next").disabled = true;
      document.getElementById("upload").disabled = true;
      document.getElementById("download").disabled = true;
    }
    window.onresize = () => {
    }
    let OnSelectImageFiles = () => {
      let topoImageFiles = document.getElementById('topo-image-files');
      _topoImageFiles = Array.from(topoImageFiles.files).map( file => {
        return { file: file }
      });
      _currentTopoImageFileIndex = 0;
      LoadCurrentTopoImageFile();
    }
    let LoadCurrentTopoImageFile = () => {
      document.getElementById("previous").disabled = (_currentTopoImageFileIndex == 0);
      document.getElementById("next").disabled = (_currentTopoImageFileIndex + 1 >= _topoImageFiles.length);
      document.getElementById("upload").disabled = (_topoImageFiles.length == 0 || _topoImageFiles[_currentTopoImageFileIndex].uploaded );
      document.getElementById("download").disabled = true;
      if( _topoImageFiles[_currentTopoImageFileIndex].topo ) {
        document.getElementById('topoID').value = _topoImageFiles[_currentTopoImageFileIndex].topo.id;
        document.getElementById('topoFilename').value = _topoImageFiles[_currentTopoImageFileIndex].topo.imageFile;
        document.getElementById("download").disabled = !(_topoImageFiles[_currentTopoImageFileIndex].topo.imageFile);
      }
      if( _topoImageFiles[_currentTopoImageFileIndex].image ) {
        DrawTopoImage(_topoImageFiles[_currentTopoImageFileIndex].image);
      }
      else {
        LoadTopoImageFile(_topoImageFiles[_currentTopoImageFileIndex].file).then( result => {
        console.log(`file '${result.file.name} loaded, content length=${result.contents.length}`);
        _topoImageFiles[_currentTopoImageFileIndex].contents = result.contents;
        LoadImage(result.contents).then( topoImage => {
          console.log(`image loaded`);
          _topoImageFiles[_currentTopoImageFileIndex].image = topoImage;
          DrawTopoImage(topoImage);
        });
      });
      }
    }
    let DrawTopoImage = (topoImage) => {
      let topoCanvas = document.getElementById('topo-canvas');
      topoCanvas.height = 500;
      topoCanvas.width = topoImage.width * topoCanvas.height / topoImage.height;
      const ctx = topoCanvas.getContext("2d");
      ctx.drawImage(topoImage, 0, 0, topoCanvas.width, topoCanvas.height);
    }
    let Next = () => {
      _currentTopoImageFileIndex++;
      LoadCurrentTopoImageFile();
    }
    let Previous = () => {
      _currentTopoImageFileIndex--;
      LoadCurrentTopoImageFile();
    }
    let LoadTopoImageFiles = (files) => {
      files.forEach( file => {
        LoadTopoImageFile(file).then( result => {
          console.log(`file '${result.file.name} loaded, content length=${result.contents.length}`);
          LoadImage(result.contents).then( topoImage => {
            console.log(`image loaded`);
            let topoCanvas = document.getElementById('topo-canvas');
            topoCanvas.height = 500;
            topoCanvas.width = topoImage.width * topoCanvas.height / topoImage.height;
            const ctx = topoCanvas.getContext("2d");
            ctx.drawImage(topoImage, 0, 0, topoCanvas.width, topoCanvas.height);
          });
        });
      });
    }
    let LoadTopoImageFile = file => new Promise( resolve => {
      console.log(file);
      let fileReader = new FileReader();
      fileReader.onload = () => resolve({file: file, contents: fileReader.result});
      fileReader.readAsDataURL(file);
    });
    let AddTopoImageTableRows = (fileDetails) => {
      let table = document.getElementById('topo-image-table');
      fileDetails.forEach( (file, index) => {
        let row = table.insertRow(index + 1);
        let cell1 = row.insertCell(0);
        cell1.innerHTML = file.name;
        let cell2 = row.insertCell(1);
        let canvas = document.createElement("CANVAS");
        canvas.height = 300;
        canvas.width = file.image.width * canvas.height / file.image.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(file.image, 0, 0, canvas.width, canvas.height);
        cell2.appendChild(canvas);
      });
    }
    let Upload = async () => {
      const canvas = document.getElementById("topo-canvas");
      const topoImageURL = canvas.toDataURL('image/jpeg', 0.5);
      const req = { imageData: topoImageURL };
      const response = await fetch('/add_topo', {
        method: 'POST',
        mode: 'same-origin',
        cache: 'no-cache',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json'
        },
        redirect: 'follow',
        referrerPolicy: 'same-origin',
        body: JSON.stringify(req)
      });
      const resData = await response.json();
      _topoImageFiles[_currentTopoImageFileIndex].uploaded = true;
      _topoImageFiles[_currentTopoImageFileIndex].topo = resData.topo;
      document.getElementById("upload").disabled = true;
      document.getElementById("download").disabled = false;
      document.getElementById('topoID').value = resData.topo.id;
      document.getElementById('topoFilename').value = resData.topo.imageFile;
      return resData;
    }
    let Download = async () => {
      const imageFilename = document.getElementById('topoFilename').value;
      const image = await LoadImage(`/get_image?filename=${imageFilename}`);
      const canvas = document.getElementById("download-topo-canvas");
      canvas.width = image.width;
      canvas.height = image.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(image, 0, 0);
    }
    </script>
</body>
</html>
