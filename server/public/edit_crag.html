<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/new.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <script src="./common.js"></script>
  <div><h1>the gnarly tyke</h1></div>
  <div><h2>edit crag</h2><div>
  <div id="topo-images-container" class="topo-images-container"></div>
  <div id="main-topo-container" class="main-topo-container">
    <canvas id="main-topo-image" class="main-topo-image"></canvas>
    <table id="topo-route-table" class="route-table">
      <thead class="route-table-header">
          <tr>
            <th>Name</th>
            <th>Grade</th>
            <th>ID</th>
          </tr>
      </thead>
    </table>
  </div>
  <div id="edit-topo-container" class="edit-topo-container">
    <div id="icon-bar" class="icon-bar">
      <label for="new-route-name">Name:</label>
      <input id="new-route-name">
      <label for="new-route-grade">Grade:</label>
      <input id="new-route-grade">
      <a href="#"><i class="fa fa-plus" id="ib-add-route"></i></a>
      <a href="#"><i class="fa fa-save" id="ib-save"></i></a>
      <a href="#"><i class="fa fa-close" id="ib-close"></i></a>
    </div>
    <div>
      <table id="crag-route-table" class="crag-route-table">
        <thead class="route-table-header">
            <tr>
              <th>Index</th>
              <th>Name</th>
              <th>Grade</th>
              <th>On topo</th>
              <th>ID</th>
            </tr>
        </thead>
      </table>
      </div>
  </div>
  <script type="module">
    let _crag = null;
    let _currentTopoID = null;
    let _topoDataMap = new Map();
    let _nextID = 0;
    let GetNextID = () => `#${_nextID++}`;
    window.onload = () => {
      EnableAllCragToposView();
      LoadCrag();
      SetupIconBarHandlers();
    }
    window.onresize = () => {
    }
    let LoadCrag = () => {
      fetch('./get_crag')
      .then(response => response.json())
      .then(crag => {
        console.log(JSON.stringify(crag));
        _crag = crag;
        UpdateCragRouteTable(_crag.routes);
        let topoContainers = CreateTopoContainers(document.getElementById('topo-images-container'), _crag.topos);
        LoadTopoImagesFromCrag(_crag, DisplayTopoImageInCragView);
      });
    }
    let CreateTopoContainers = (parentContainer, topos) => {
      let topoContainers = [];
      topos.forEach(topo => {
        let topoContainer = parentContainer.appendChild(document.createElement('div'));
        topoContainer.setAttribute('data-id', topo.id);
        topoContainer.setAttribute('data-filename', topo.imageFile);
        topoContainers.push(topoContainer);
      });
      return topoContainers;
    }
    let DisplayTopoImageInCragView = (topo, topoImage) => {
      console.log(`loaded image for topo '${topo.id}'`);
      let topoImagesContainer = document.getElementById('topo-images-container');
      Array.from(topoImagesContainer.children).forEach( topoContainer => {
        let containerID = topoContainer.getAttribute('data-id');
        console.log(`container id: '${containerID}'`);
        if( topo.id == containerID) {
          let topoCanvas = CreateTopoCanvas(topoImage, 15);
          topoContainer.appendChild(topoCanvas);
          let ctx = topoCanvas.getContext('2d');
          ctx.drawImage(topoImage, 0, 0, topoCanvas.width, topoCanvas.height);
          let idText = topoContainer.appendChild(document.createElement('p'));
          idText.innerText = topo.id;
          topoCanvas.onclick = event => {
            _currentTopoID = topo.id;
            DrawMainTopoImage(topoImage);
            EnableMainTopoView();
          }
        }
      });
    }
    let CreateTopoCanvas = (topoImage, heightInRem) => {
      let canvas = document.createElement('CANVAS');
      let height = 15;
      let width = topoImage.width * height / topoImage.height;
      canvas.setAttribute('class', 'topo-image');
      canvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      canvas.setAttribute('width', topoImage.width);
      canvas.setAttribute('height', topoImage.height);
      return canvas;
    }
    let SetupIconBarHandlers = () => {
      document.getElementById("ib-add-route").onclick = event => {
        let newRouteName = document.getElementById('new-route-name').value;
        let newRouteGrade = document.getElementById('new-route-grade').value;
        console.log(`new route name: ${newRouteName}`);
        if( newRouteName.length > 0 ) {
          AddRouteToCragRouteTable(newRouteName, newRouteGrade);
        }
      }
      document.getElementById("ib-save").onclick = event => {
        SaveCrag();
      }
      document.getElementById("ib-close").onclick = event => {
        EnableAllCragToposView();
      }
    }
    let SaveCrag = () => {
      _crag.routes = GetCragRoutes();
      let currentTopoRoutes = GetRoutesForCurrentTopo();
      _topoDataMap.set(_currentTopoID, currentTopoRoutes);
      _crag.topos.forEach( topo => {
        let updatedTopoRoutes = _topoDataMap.get(topo.id);
        if( updatedTopoRoutes ) topo.routes = updatedTopoRoutes;
      });
      let req = _crag;
      fetch('./save_crag', {
        method: 'POST',
        mode: 'same-origin',
        cache: 'no-cache',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json'
        },
        redirect: 'follow',
        referrerPolicy: 'same-origin',
        body: JSON.stringify(req)
      })
      .then(response => response.json())
      .then(response => {
        console.log(`${JSON.stringify(response)}`);
      })
      .catch(err => {
        console.log(`$err.toString()}`);
      });
    }
    let UpdateCragRouteTable = (routes) => {
      let routeTable = document.getElementById("crag-route-table");
      DeleteAllTableRowsExceptHeader(routeTable);
      routes.forEach( route => {
        AddRouteToCragRouteTable(route.name, route.grade, route.id);
      });
    }
    let UpdateTopoRouteTableFromCragRouteTable = () => {
      let cragRouteTable = document.getElementById("crag-route-table");
      let topoRouteTable = document.getElementById("topo-route-table");
      DeleteAllTableRowsExceptHeader(topoRouteTable);
      GetTableRowsWithoutHeader(cragRouteTable).forEach( row => {
        let routeName = row.cells[1].innerText;
        let routeGrade = row.cells[2].innerText;
        let routeID = row.cells[4].innerText;
        if( IsTableCellChecked(row, 3) ) {
          let newRouteIndex = topoRouteTable.rows.length;
          let newRouteRow = topoRouteTable.insertRow(newRouteIndex);
          newRouteRow.insertCell(0).innerText = routeName;
          newRouteRow.insertCell(1).innerText = routeGrade;
          newRouteRow.insertCell(2).innerText = routeID;
        }
      });
    }
    // let CreateTopoCanvas = (topoID, topoImageFile, topoImage) => {
    //   let canvas = document.createElement('CANVAS');
    //   canvas.setAttribute('data-id', topoID);
    //   canvas.setAttribute('data-filename', topoImageFile);
    //   let height = 15;
    //   let width = topoImage.width * height / topoImage.height;
    //   canvas.setAttribute('class', 'topo-image');
    //   canvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
    //   canvas.setAttribute('width', topoImage.width);
    //   canvas.setAttribute('height', topoImage.height);
    //   return canvas;
    // }
    let DrawMainTopoImage = topoImage => {
      console.log(`mouse clicked on image`);
      console.log(`${event.currentTarget}`);
      console.log(`${event.currentTarget.dataset.id}`);
      console.log(`${event.currentTarget.dataset.filename}`);
      let destCanvas = document.getElementById('main-topo-image');
      let width = 60;
      let height = topoImage.height * width / topoImage.width;
      destCanvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      destCanvas.setAttribute('width', topoImage.width);
      destCanvas.setAttribute('height', topoImage.height);
      destCanvas.height = topoImage.height;
      destCanvas.width = topoImage.width * destCanvas.height / topoImage.height;
      destCanvas.onclick = event => {
      }
      let destCanvasCtx = destCanvas.getContext('2d');
      destCanvasCtx.drawImage(topoImage, 0, 0, destCanvas.width, destCanvas.height);
    }
    let EnableAllCragToposView = () => {
      document.getElementById('edit-topo-container').classList.add('do-not-display');
      document.getElementById('icon-bar').classList.add('do-not-display');
      document.getElementById('topo-images-container').classList.remove('do-not-display');
      document.getElementById('main-topo-container').classList.add('do-not-display');
    }
    let EnableMainTopoView = () => {
      let topo = GetTopoFromCragData(_crag, _currentTopoID);
      console.log(`topo: ${JSON.stringify(topo)}`);
      if( topo && topo.routes ) SetCragTableRoutesAsTopoRoutes(topo.routes);
      UpdateTopoRouteTableFromCragRouteTable();
      document.getElementById('edit-topo-container').classList.remove('do-not-display');
      document.getElementById('icon-bar').classList.remove('do-not-display');
      document.getElementById('topo-images-container').classList.add('do-not-display');
      document.getElementById('main-topo-container').classList.remove('do-not-display');
    }
    let AddRouteToCragRouteTable = (routeName, routeGrade, routeID) => {
      let routeTable = document.getElementById("crag-route-table");
      let newRouteIndex = routeTable.rows.length;
      let newRouteRow = routeTable.insertRow(newRouteIndex);
      newRouteRow.insertCell(0).innerText = newRouteIndex;
      newRouteRow.insertCell(1).innerText = routeName;
      newRouteRow.insertCell(2).innerText = routeGrade;
      newRouteRow.insertCell(3).innerText = routeID ? routeID : GetNextID();
      let checkBox = document.createElement('input');
      checkBox.setAttribute('type', 'checkbox');
      checkBox.onchange = event => {
        console.log(`check box changed`);
        UpdateTopoRouteTableFromCragRouteTable();
      };
      newRouteRow.insertCell(3).appendChild(checkBox);
    }
    let GetCragRoutes = () => {
      let routes = [];
      let routeTable = document.getElementById("crag-route-table");
      let rows = GetTableRowsWithoutHeader(routeTable);
      rows.forEach(row => {
        let routeName = row.cells[1].innerText;
        let routeGrade = row.cells[2].innerText;
        let routeID = row.cells[4].innerText;
        routes.push({id: routeID, name: routeName, grade: routeGrade});
      });
      return routes;
    }
    let GetCragRouteIndicesForCurrentTopo = () => {
      let routeTable = document.getElementById("crag-route-table");
      let rows = GetTableRowsWithoutHeader(routeTable);
      let routeIndices = [];
      rows.forEach((row, index) => {
        if( IsTableCellSelected(row, 3) ) routeIndices.push(index);
      });
      return routeIndices;
    }
    let GetRoutesForCurrentTopo = () => {
      let routeTable = document.getElementById("crag-route-table");
      let rows = GetTableRowsWithoutHeader(routeTable);
      let currentTopoRoutes = [];
      rows.forEach( row => {
        if( IsTableCellChecked(row, 3) ) currentTopoRoutes.push({ id: row.cells[4].innerText });
      });
      return currentTopoRoutes;
    }
    let FormatTopoDataToSave = () => {
      let topoDataToSave = [];
      _topoDataMap.forEach( (value, key) => {
        topoDataToSave.push({ id: key, routes: value });
      });
      return topoDataToSave;
    }
    let GetTopoFromCragData = (cragData, topoID) => {
      let topoRoutes = null;
      console.log(`crag data: ${JSON.stringify(cragData)}`);
      let matchingTopos = cragData.topos.filter( topo => topo.id == topoID );
      return matchingTopos.length == 0 ? null : matchingTopos[0];
    }
    let SetCragTableRoutesAsTopoRoutes = (routes) => {
      console.log(`UpdateSelectedCragRoutes`);
      let setOfRouteIDs = new Set(routes.map(route => route.id));
      let cragRouteTableElement = document.getElementById('crag-route-table');
      let cragRouteTableRows = GetTableRowsWithoutHeader(cragRouteTableElement);
      cragRouteTableRows.forEach( row => {
        let rowID = row.cells[4].innerText;
        row.cells[3].firstChild.checked = setOfRouteIDs.has(rowID);
      });
    }
    </script>
</body>
</html>
