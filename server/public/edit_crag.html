<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/default.css">
</head>
<body>
  <script src="./common.js"></script>
  <h1>the gnarly tyke</h1>
  <div>
    <h2>edit crag</h2>
  </div>
  <div id="topo-images" class="topo-images"></div>
  <div id="selected-topo-container" class="topo-images">
    <canvas id="selected-topo-image" class="topo-image"></canvas>
  </div>
  <script>
    let _crag = null;
    window.onload = () => {
      document.getElementById('selected-topo-container').style.display = 'none';
      fetch('./get_crag')
      .then(response => response.json())
      .then(crag => {
        console.log(JSON.stringify(crag));
        _crag = crag;
        _crag.topos.forEach( topo => {
          let topoID = topo.id;
          let topoImageFile = topo.imageFile;
          console.log(`image file: ${topoImageFile}`);
          LoadImage(`./get_image?filename=${topoImageFile}`)
          .then( topoImage => {
            console.log(`image loaded: width=${topoImage.width}, height=${topoImage.height}`);
            let topoImagesContainer = document.getElementById('topo-images');
            let canvas = CreateTopoCanvas(topoID, topoImageFile, topoImage);
            let topoCanvas = topoImagesContainer.appendChild(canvas);
            let ctx = topoCanvas.getContext('2d');
            ctx.drawImage(topoImage, 0, 0, topoCanvas.width, topoCanvas.height);
          });
        });
      });
    }
    window.onresize = () => {
    }
    let CreateTopoCanvas = (topoID, topoImageFile, topoImage) => {
      let canvas = document.createElement('CANVAS');
      canvas.setAttribute('data-id', topoID);
      canvas.setAttribute('data-filename', topoImageFile);
      canvas.setAttribute('class', 'topo-image');
      canvas.setAttribute('height', 200);
      canvas.setAttribute('width', topoImage.width * 200 / topoImage.height);
      canvas.onclick = event => {
        console.log(`mouse clicked on image`);
        console.log(`${event.currentTarget}`);
        console.log(`${event.currentTarget.dataset.id}`);
        console.log(`${event.currentTarget.dataset.filename}`);
        let destCanvas = document.getElementById('selected-topo-image');
        destCanvas.height = 600;
        destCanvas.width = topoImage.width * 600 / topoImage.height;
        destCanvas.onclick = event => {
          document.getElementById('topo-images').style.display = "flex";
          document.getElementById('selected-topo-container').style.display = 'none';
        }
        let destCanvasCtx = destCanvas.getContext('2d');
        LoadImage(`./get_image?filename=${topoImageFile}`)
        .then( topoImage => {
          console.log(`image loaded: width=${topoImage.width}, height=${topoImage.height}`);
          destCanvasCtx.drawImage(topoImage, 0, 0, destCanvas.width, destCanvas.height);
        });
        document.getElementById('topo-images').style.display = "none";
        document.getElementById('selected-topo-container').style.display = 'flex';
      }
      return canvas;
    }
    </script>
</body>
</html>
