<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/new.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <script src="./common.js"></script>
  <div><h1>the gnarly tyke</h1></div>
  <div><h2>edit crag</h2><div>
  <div id="topo-images-container" class="topo-images-container"></div>
  <div id="main-topo-container" class="main-topo-container">
    <canvas id="main-topo-image" class="main-topo-image"></canvas>
    <table id="topo-route-table" class="route-table">
      <thead class="route-table-header">
          <tr>
            <th>Name</th>
            <th>Grade</th>
          </tr>
      </thead>
    </table>
  </div>
  <div id="edit-topo-container" class="edit-topo-container">
    <div id="icon-bar" class="icon-bar">
      <label for="new-route-name">Name:</label>
      <input id="new-route-name">
      <label for="new-route-grade">Grade:</label>
      <input id="new-route-grade">
      <a href="#"><i class="fa fa-plus" id="ib-add-route"></i></a>
      <a href="#"><i class="fa fa-save" id="ib-save"></i></a>
      <a href="#"><i class="fa fa-close" id="ib-close"></i></a>
    </div>
    <div>
      <table id="crag-route-table" class="route-table">
        <thead class="route-table-header">
            <tr>
              <th>Index</th>
              <th>Name</th>
              <th>Grade</th>
            </tr>
        </thead>
      </table>
      </div>
  </div>
  <script type="module">
    let _crag = null;
    let _transactions = [];
    let _routeTableTransactionsApplied = 0;
    window.onload = () => {
      EnableAllCragToposView();
      fetch('./get_crag')
      .then(response => response.json())
      .then(crag => {
        console.log(JSON.stringify(crag));
        _crag = crag;
        UpdateCragRouteTable(_crag.routes);
        _crag.topos.forEach( topo => {
          let topoID = topo.id;
          let topoImageFile = topo.imageFile;
          console.log(`image file: ${topoImageFile}`);
          LoadImage(`./get_image?filename=${topoImageFile}`)
          .then( topoImage => {
            console.log(`image loaded: width=${topoImage.width}, height=${topoImage.height}`);
            let topoImagesContainer = document.getElementById('topo-images-container');
            let canvas = CreateTopoCanvas(topoID, topoImageFile, topoImage);
            let topoCanvas = topoImagesContainer.appendChild(canvas);
            let ctx = topoCanvas.getContext('2d');
            ctx.drawImage(topoImage, 0, 0, topoCanvas.width, topoCanvas.height);
          });
        });
      });
      document.getElementById("ib-add-route").onclick = event => {
        let newRouteName = document.getElementById('new-route-name').value;
        let newRouteGrade = document.getElementById('new-route-grade').value;
        console.log(`new route name: ${newRouteName}`);
        if( newRouteName.length > 0 ) {
          AddRoute(newRouteName, newRouteGrade);
        }
      }
      document.getElementById("ib-save").onclick = event => {
        let req = { routes: GetCragRoutes() };
        fetch('./save_crag', {
          method: 'POST',
          mode: 'same-origin',
          cache: 'no-cache',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json'
          },
          redirect: 'follow',
          referrerPolicy: 'same-origin',
          body: JSON.stringify(req)
        })
        .then(response => response.json())
        .then(response => {
          console.log(`${JSON.stringify(response)}`);
        })
        .catch(err => {
          console.log(`$err.toString()}`);
        });
      }
      document.getElementById("ib-close").onclick = event => {
        EnableAllCragToposView();
      }
    }
    window.onresize = () => {
    }
    let UpdateCragRouteTable = (routes) => {
      let routeTable = document.getElementById("crag-route-table");
      while( routeTable.rows.length > 1 ) routeTable.deleteRow(1);
      routes.forEach( route => {
        AddRoute(route.name, route.grade);
      });
    }
    let CreateTopoCanvas = (topoID, topoImageFile, topoImage) => {
      let canvas = document.createElement('CANVAS');
      canvas.setAttribute('data-id', topoID);
      canvas.setAttribute('data-filename', topoImageFile);
      let height = 15;
      let width = topoImage.width * height / topoImage.height;
      canvas.setAttribute('class', 'topo-image');
      canvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      canvas.setAttribute('width', topoImage.width);
      canvas.setAttribute('height', topoImage.height);
      canvas.onclick = event => {
        DrawMainTopoImage(topoImage);
        EnableMainTopoView();
      }
      return canvas;
    }
    let DrawMainTopoImage = topoImage => {
      console.log(`mouse clicked on image`);
      console.log(`${event.currentTarget}`);
      console.log(`${event.currentTarget.dataset.id}`);
      console.log(`${event.currentTarget.dataset.filename}`);
      let destCanvas = document.getElementById('main-topo-image');
      let width = 40;
      let height = topoImage.height * width / topoImage.width;
      destCanvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      destCanvas.setAttribute('width', topoImage.width);
      destCanvas.setAttribute('height', topoImage.height);
      destCanvas.height = topoImage.height;
      destCanvas.width = topoImage.width * destCanvas.height / topoImage.height;
      destCanvas.onclick = event => {
      }
      let destCanvasCtx = destCanvas.getContext('2d');
      destCanvasCtx.drawImage(topoImage, 0, 0, destCanvas.width, destCanvas.height);
    }
    let EnableAllCragToposView = () => {
      document.getElementById('edit-topo-container').classList.add('do-not-display');
      document.getElementById('icon-bar').classList.add('do-not-display');
      document.getElementById('topo-images-container').classList.remove('do-not-display');
      document.getElementById('main-topo-container').classList.add('do-not-display');
    }
    let EnableMainTopoView = () => {
      document.getElementById('edit-topo-container').classList.remove('do-not-display');
      document.getElementById('icon-bar').classList.remove('do-not-display');
      document.getElementById('topo-images-container').classList.add('do-not-display');
      document.getElementById('main-topo-container').classList.remove('do-not-display');
    }
    let AddRoute = (routeName, routeGrade) => {
      let routeTable = document.getElementById("crag-route-table");
      let newRouteIndex = routeTable.rows.length;
      let newRouteRow = routeTable.insertRow(newRouteIndex);
      newRouteRow.insertCell(0).innerText = newRouteIndex;
      newRouteRow.insertCell(1).innerText = routeName;
      newRouteRow.insertCell(2).innerText = routeGrade;
    }
    let GetCragRoutes = () => {
      let routes = [];
      let routeTable = document.getElementById("crag-route-table");
      let rows = Array.from(routeTable.rows).filter( (row, index) => index > 0 );
      rows.forEach(row => {
        let routeName = row.cells[1].innerText;
        let routeGrade = row.cells[2].innerText;
        routes.push({name: routeName, grade: routeGrade});
      });
      return routes;
    }
    let GetTransactionsByType = type => _transactions.filter( transaction => transaction.type == "route" );
    let GetTransactionsToApply = (transactions, transactionsApplied) => transactions.slice(transactionsApplied);
    </script>
</body>
</html>
