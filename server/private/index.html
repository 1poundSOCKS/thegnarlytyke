<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>the gnarly tyke</title>
    <link rel="stylesheet" href="stylesheets/default.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <script src="./common.js"></script>
  <div><h1>the gnarly tyke</h1></div>
  <div><h2>edit crag</h2><div>
  <div id="topo-images-container" class="topo-images-container"></div>
  <div><p id="current-topo-id"></p></div>
  <div id="main-topo-container" class="main-topo-container">
    <canvas id="main-topo-image" class="main-topo-image"></canvas>
    <table id="topo-route-table" class="topo-route-table">
      <thead class="topo-route-table-header">
          <tr>
            <th>Name</th>
            <th>Grade</th>
            <th>ID</th>
            <th>Edit</th>
            <th>Index</th>
          </tr>
      </thead>
    </table>
  </div>
  <div id="edit-topo-container" class="edit-topo-container">
    <div id="icon-bar" class="icon-bar">
      <label for="new-route-name">Name:</label>
      <input id="new-route-name">
      <label for="new-route-grade">Grade:</label>
      <input id="new-route-grade">
      <a href="#"><i class="fa fa-plus" id="ib-add-route"></i></a>
      <a href="#"><i class="fa fa-save" id="ib-save"></i></a>
    </div>
    <div>
      <table id="crag-route-table" class="crag-route-table">
        <thead class="crag-route-table-header">
            <tr>
              <th>Index</th>
              <th data-property-name="name">Name</th>
              <th data-property-name="grade">Grade</th>
              <th data-property-name="onTopo">On topo</th>
              <th data-property-name="id">ID</th>
              <th data-property-name="points">Points</th>
            </tr>
        </thead>
      </table>
      </div>
  </div>
  <script type="module">
    let _crag = null;
    let _currentTopoID = null;
    let _currentTopoImage = null;
    let _topoDataMap = new Map();
    let _nextID = 0;
    let GetNextID = () => `#${_nextID++}`;
    window.onload = () => {
      LoadCrag();
      SetupIconBarHandlers();
    }
    window.onresize = () => {
    }
    let LoadCrag = () => {
      fetch('./get_crag')
      .then(response => response.json())
      .then(crag => {
        _crag = crag;
        UpdateCragRouteTable(_crag.routes);
        let topoContainers = CreateTopoContainers(document.getElementById('topo-images-container'), _crag.topos);
        LoadTopoImagesFromCrag(_crag, DisplayTopoImageInCragView);
      });
    }
    let CreateTopoContainers = (parentContainer, topos) => {
      let topoContainers = [];
      topos.forEach(topo => {
        let topoContainer = parentContainer.appendChild(document.createElement('div'));
        topoContainer.classList.add('topo-container');
        topoContainer.setAttribute('data-id', topo.id);
        topoContainer.setAttribute('data-filename', topo.imageFile);
        topoContainers.push(topoContainer);
      });
      return topoContainers;
    }
    let DisplayTopoImageInCragView = (cragObject, topo, topoImage) => {
      console.log(`loaded image for topo '${topo.id}'`);
      let topoImagesContainer = document.getElementById('topo-images-container');
      let matchingTopoContainers = Array.from(topoImagesContainer.children).filter( topoContainer => {
        return topoContainer.getAttribute('data-id') == topo.id;
      });
      console.assert(matchingTopoContainers.length == 1);
      let topoContainer = matchingTopoContainers[0];
      let topoCanvas = CreateTopoCanvas(topoImage, 10);
      topoContainer.appendChild(topoCanvas);
      let ctx = topoCanvas.getContext('2d');
      ctx.drawImage(topoImage, 0, 0, topoCanvas.width, topoCanvas.height);
      topoCanvas.onclick = event => {
        SaveCurrentTopoToCragObject(cragObject);
        SwitchMainTopoView(topo, topoImage);
      }
      AddControlsToTopoContainer(topoContainer, topo);
    }
    let SaveCurrentTopoToCragObject = (cragObject) => {
      let currentTopoID = document.getElementById('current-topo-id').innerText;
      if( currentTopoID.length == 0 ) return;
      let tableElement = document.getElementById('crag-route-table');
      console.assert(tableElement.rows[0]);
      let headerCellsArray = Array.from(tableElement.rows[0].cells);
      let headerCellsWithPropertyName = headerCellsArray.filter( cell => cell.dataset.propertyName );
      let headerPropertyArray = headerCellsWithPropertyName.map( cell => {
        return { cellIndex: cell.cellIndex, cellPropertyName: cell.dataset.propertyName };
      });
      let tableData = GetTableRowsWithoutHeader(tableElement).map( row => {
        let newObject = {};
        headerPropertyArray.forEach( property => {
          let cellElement = row.cells[property.cellIndex];
          let firstChildElement = cellElement.children[0];
          if( firstChildElement ) newObject[property.cellPropertyName] = firstChildElement.checked;
          else newObject[property.cellPropertyName] = cellElement.innerText;
        });
        return newObject;
      });
      let tableDataToSave = tableData.map( row => { return { id: row.id, name: row.name, grade: row.grade} });
      cragObject.routes = tableDataToSave;
      
      let topoRouteTableData = tableData.filter( row => row.onTopo );
      let topoRouteDataToSave = topoRouteTableData.map( row => {
        let points = row.points ? JSON.parse(row.points) : [];
        return { id: row.id, points: points };
      });
      console.table(topoRouteDataToSave);
      let topoToUpdate = cragObject.topos.filter( topoObject => topoObject.id == currentTopoID );
      console.assert(topoToUpdate[0]);
      topoToUpdate[0].routes = topoRouteDataToSave;
      console.log(JSON.stringify(topoToUpdate[0], null, 2));
    }
    let SwitchMainTopoView = (topoObject, topoImage) => {
      _currentTopoID = topoObject.id;
      document.getElementById('current-topo-id').textContent = _currentTopoID;
      _currentTopoImage = topoImage;
      let mainTopoCanvas = DrawMainTopoImage(topoImage);
      AddMouseHandlerToTopoCanvas(topoObject, topoImage, mainTopoCanvas);
      RefreshMainTopoView(topoObject, topoImage);
    }
    let AddMouseHandlerToTopoCanvas = (topoObject, topoImage, topoCanvas) => {
      topoCanvas.onclick = event => {
        let rect = topoCanvas.getBoundingClientRect();
        let clientRectWidth = rect.right - rect.left;
        let clientRectHeight = rect.bottom - rect.top;
        console.log(`client size: ${clientRectWidth}, ${clientRectHeight}`);
        
        let clientMouseX = event.clientX - rect.left;
        let clientMouseY = event.clientY - rect.top;
        console.log(`mouse position: ${clientMouseX}, ${clientMouseY}`);
        
        let mousePercentX = clientMouseX / clientRectWidth;
        let mousePercentY = clientMouseY / clientRectHeight;
        console.log(`mouse position (fraction): ${mousePercentX}, ${mousePercentY}`);
        
        let newPoint = { id: GetNextID(), x: mousePercentX, y: mousePercentY };
        let checkedRows = GetCheckedTopoRouteTableRows();
        
        if( checkedRows.length > 0 ) {
          // update the crag route table with point data...
          // get the existing point data from the crag table
          let firstCheckedRow = checkedRows[0];
          let matchingCragTableRows = GetTableRowsWithoutHeader(document.getElementById('crag-route-table'))
          .filter( row => row.cells[4].innerText == firstCheckedRow.cells[2].innerText );
          console.assert(matchingCragTableRows.length > 0);
          let routeDataText = matchingCragTableRows[0].cells[5].innerText;
          
          // append the new point to the data
          let routeDataObject = ( routeDataText.length == 0 ) ? [] : JSON.parse(routeDataText);
          routeDataObject.push(newPoint);
          
          // update the point data on the crag route table
          matchingCragTableRows[0].cells[5].innerText = JSON.stringify(routeDataObject);
          
          let ctx = topoCanvas.getContext('2d');
          DrawMainTopoImage(_currentTopoImage);
          DrawTopoRoutes(ctx);
        }
      }
    }
    let DrawTopoRoutes = (ctx) => {
      GetCheckedCragTableRows().forEach( (row, rowIndex) => {
        let routeDataText = row.cells[5].innerText;
        if( routeDataText.length > 0 ) {
          let routeDataObject = JSON.parse(routeDataText);
          let pointsOnCanvas = routeDataObject.map( point => {
            return { x: ctx.canvas.width * point.x, y: ctx.canvas.height * point.y };
          });
          pointsOnCanvas.forEach( (point, pointIndex, points) => {
            let nextPoint = points[pointIndex+1];
            if( nextPoint ) DrawRouteLine(ctx, point.x, point.y, nextPoint.x, nextPoint.y, 1);
            DrawRouteStart(ctx, point.x, point.y, rowIndex + 1, 1);
          });
        }
      });
    }
    let DrawRouteStart = (ctx, canvasX, canvasY, routeIndex, fontSize) => {
      console.log(`canvas position: ${canvasX}, ${canvasY}`);
      ctx.font = `bold ${fontSize}rem serif`;
      const metrics = ctx.measureText(routeIndex);
      let widthOfRouteIndex = metrics.width;
      ctx.beginPath();
      ctx.setLineDash([]);
      ctx.arc(canvasX, canvasY, widthOfRouteIndex, 0, 2 * Math.PI, false);
      ctx.fillStyle = "#FFFFFF";
      ctx.fill();
      ctx.beginPath();
      ctx.arc(canvasX, canvasY, widthOfRouteIndex, 0, 2 * Math.PI, false);
      ctx.lineWidth = fontSize;
      ctx.strokeStyle = "#000000";
      ctx.stroke();
      ctx.fillStyle = "#000000";
      ctx.fillText(routeIndex, canvasX - (widthOfRouteIndex * 0.5), canvasY + (widthOfRouteIndex * 0.75));
    }
    let DrawRouteLine = (ctx, canvasStartX, canvasStartY, canvasEndX, canvasEndY, width) => {
      ctx.beginPath();
      ctx.moveTo(canvasStartX, canvasStartY);
      ctx.lineTo(canvasEndX, canvasEndY);
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#FFFFFF';
      ctx.stroke();
    }
    let GetCheckedTopoRouteTableRows = () => {
      let topoRouteTable = document.getElementById('topo-route-table');
      let topoRouteTableRows = GetTableRowsWithoutHeader(topoRouteTable);
      console.log(`checking ${topoRouteTableRows.length} rows`);
      return topoRouteTableRows.filter( row => IsTableCellChecked(row, 3) );      
    }
    let CreateTopoCanvas = (topoImage, heightInRem) => {
      let canvas = document.createElement('CANVAS');
      canvas.classList.add('topo-image');
      let height = heightInRem;
      let width = topoImage.width * height / topoImage.height;
      canvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      canvas.setAttribute('width', topoImage.width);
      canvas.setAttribute('height', topoImage.height);
      return canvas;
    }
    let AddControlsToTopoContainer = (topoContainer, topo) => {
      let saveLink = topoContainer.appendChild(document.createElement('a'));
      topoContainer.setAttribute('href', '#');
      let saveIcon = saveLink.appendChild(document.createElement('i'));
      saveIcon.setAttribute('class', 'fa fa-close');
      saveLink.onclick = event => {
        console.log(`delete topo '${topo.id}'`);
        DeleteTopoFromCragObject(_crag, topo.id);
        topoContainer.remove();
      }
    }
    let SetupIconBarHandlers = () => {
      document.getElementById("ib-add-route").onclick = event => {
        let newRouteName = document.getElementById('new-route-name').value;
        let newRouteGrade = document.getElementById('new-route-grade').value;
        console.log(`new route name: ${newRouteName}`);
        if( newRouteName.length > 0 ) {
          AddRouteToCragRouteTable(newRouteName, newRouteGrade);
        }
      }
      document.getElementById("ib-save").onclick = event => {
        SaveCrag();
      }
    }
    let SaveCrag = () => {
      _crag.routes = GetCragRoutes();
      let currentTopoRoutes = GetRoutesForCurrentTopo();
      _topoDataMap.set(_currentTopoID, currentTopoRoutes);
      _crag.topos.forEach( topo => {
        let updatedTopoRoutes = _topoDataMap.get(topo.id);
        if( updatedTopoRoutes ) topo.routes = updatedTopoRoutes;
      });
      let req = _crag;
      fetch('./save_crag', {
        method: 'POST',
        mode: 'same-origin',
        cache: 'no-cache',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json'
        },
        redirect: 'follow',
        referrerPolicy: 'same-origin',
        body: JSON.stringify(req)
      })
      .then(response => response.json())
      .then(response => {
        console.log(`${JSON.stringify(response)}`);
      })
      .catch(err => {
        console.log(`$err.toString()}`);
      });
    }
    let UpdateCragRouteTable = (routes) => {
      let routeTable = document.getElementById("crag-route-table");
      DeleteAllTableRowsExceptHeader(routeTable);
      routes.forEach( route => {
        AddRouteToCragRouteTable(route.name, route.grade, route.id);
      });
    }
    let UpdateTopoRouteTableFromCragRouteTable = () => {
      let cragRouteTable = document.getElementById("crag-route-table");
      let topoRouteTable = document.getElementById("topo-route-table");
      DeleteAllTableRowsExceptHeader(topoRouteTable);
      GetCheckedCragTableRows().forEach( row => {
        let routeName = row.cells[1].innerText;
        let routeGrade = row.cells[2].innerText;
        let routeID = row.cells[4].innerText;
        let newRouteIndex = topoRouteTable.rows.length;
        let newRouteRow = topoRouteTable.insertRow(newRouteIndex);
        newRouteRow.insertCell(0).innerText = routeName;
        newRouteRow.insertCell(1).innerText = routeGrade;
        newRouteRow.insertCell(2).innerText = routeID;
        newRouteRow.insertCell(3).appendChild(CreateCheckboxInputElement());
        newRouteRow.insertCell(4).innerText = newRouteIndex;
        newRouteRow.insertCell(5).innerText = '';
      });
      let topoCanvas = document.getElementById('main-topo-image');
      let ctx = topoCanvas.getContext('2d');
      DrawMainTopoImage(_currentTopoImage);
      DrawTopoRoutes(ctx);
    }
    let GetCheckedCragTableRows = () => {
      let cragRouteTable = document.getElementById("crag-route-table");
      return GetTableRowsWithoutHeader(cragRouteTable).filter( row => IsTableCellChecked(row, 3) );
    }
    let CreateCheckboxInputElement = () => {
      let inputElement = document.createElement('input');
      inputElement.setAttribute('type','checkbox');
      return inputElement;
    }
    let DrawMainTopoImage = topoImage => {
      let destCanvas = document.getElementById('main-topo-image');
      let width = 60;
      let height = topoImage.height * width / topoImage.width;
      destCanvas.setAttribute('style', `width: ${width}rem; height: ${height}rem;`);
      destCanvas.setAttribute('width', topoImage.width);
      destCanvas.setAttribute('height', topoImage.height);
      destCanvas.height = topoImage.height;
      destCanvas.width = topoImage.width * destCanvas.height / topoImage.height;
      let destCanvasCtx = destCanvas.getContext('2d');
      destCanvasCtx.drawImage(topoImage, 0, 0, destCanvas.width, destCanvas.height);
      return destCanvas;
    }
    let RefreshMainTopoView = (topoObject, topoImage) => {
      if( topoObject?.routes ) SetCragTableRoutesAsTopoRoutes(topoObject.routes);
      UpdateTopoRouteTableFromCragRouteTable();
    }
    let AddRouteToCragRouteTable = (routeName, routeGrade, routeID) => {
      let routeTable = document.getElementById("crag-route-table");
      let newRouteIndex = routeTable.rows.length;
      let newRouteRow = routeTable.insertRow(newRouteIndex);
      newRouteRow.insertCell(0).innerText = newRouteIndex;
      newRouteRow.insertCell(1).innerText = routeName;
      newRouteRow.insertCell(2).innerText = routeGrade;
      let checkbox = CreateCheckboxInputElement();
      checkbox.onchange = event => {
        console.log(`check box changed`);
        UpdateTopoRouteTableFromCragRouteTable();
      };
      newRouteRow.insertCell(3).appendChild(checkbox);
      newRouteRow.insertCell(4).innerText = routeID ? routeID : GetNextID();
      newRouteRow.insertCell(5).innerText = '';
    }
    let GetCragRoutes = () => {
      let routes = [];
      let routeTable = document.getElementById("crag-route-table");
      let rows = GetTableRowsWithoutHeader(routeTable);
      rows.forEach(row => {
        let routeName = row.cells[1].innerText;
        let routeGrade = row.cells[2].innerText;
        let routeID = row.cells[4].innerText;
        routes.push({id: routeID, name: routeName, grade: routeGrade});
      });
      return routes;
    }
    let GetCragRouteIndicesForCurrentTopo = () => {
      let routeTable = document.getElementById("crag-route-table");
      let rows = GetTableRowsWithoutHeader(routeTable);
      let routeIndices = [];
      rows.forEach((row, index) => {
        if( IsTableCellSelected(row, 3) ) routeIndices.push(index);
      });
      return routeIndices;
    }
    let GetRoutesForCurrentTopo = () => {
      let routeTable = document.getElementById("crag-route-table");
      let rows = GetTableRowsWithoutHeader(routeTable);
      let currentTopoRoutes = [];
      rows.forEach( row => {
        if( IsTableCellChecked(row, 3) ) currentTopoRoutes.push({ id: row.cells[4].innerText });
      });
      return currentTopoRoutes;
    }
    let FormatTopoDataToSave = () => {
      let topoDataToSave = [];
      _topoDataMap.forEach( (value, key) => {
        topoDataToSave.push({ id: key, routes: value });
      });
      return topoDataToSave;
    }
    let GetTopoFromCragData = (cragData, topoID) => {
      let topoRoutes = null;
      console.log(`crag data: ${JSON.stringify(cragData)}`);
      let matchingTopos = cragData.topos.filter( topo => topo.id == topoID );
      return matchingTopos.length == 0 ? null : matchingTopos[0];
    }
    let SetCragTableRoutesAsTopoRoutes = (routes) => {
      console.log(`UpdateSelectedCragRoutes`);
      let setOfRouteIDs = new Map(routes.map(route => [route.id, route]));
      let cragRouteTableElement = document.getElementById('crag-route-table');
      let cragRouteTableRows = GetTableRowsWithoutHeader(cragRouteTableElement);
      cragRouteTableRows.forEach( row => {
        let rowID = row.cells[4].innerText;
        let route = setOfRouteIDs.get(rowID);
        if( route ) {
          row.cells[3].firstChild.checked = true;
          row.cells[5].innerText = route.points ? JSON.stringify(route.points) : '';
        }
        else {
          row.cells[3].firstChild.checked = false;
          row.cells[5].innerText = '';
        }
      });
    }
    </script>
</body>
</html>
